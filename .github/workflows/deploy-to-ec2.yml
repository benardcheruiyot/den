


        name: Deploy Pata.Mkopaji App to EC2 Ubuntu

        on:
          push:
            branches: [ main ]
          workflow_dispatch:

        env:
          NODE_VERSION: '18'
          APP_NAME: 'pata-mkopaji-production'

        jobs:
          deploy:
            name: Deploy to EC2
            runs-on: ubuntu-latest
            steps:
              - name: üöÄ Checkout repository
                uses: actions/checkout@v4

              - name: üèóÔ∏è Setup Node.js
                uses: actions/setup-node@v4
                with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

              - name: üì¶ Install dependencies
                run: npm ci

              - name: üßπ Clean deployment directory
                uses: appleboy/ssh-action@v1.2.1
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: root
                  key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                    rm -rf /var/www/html/pata.mkopaji/*

              - name: üìÅ Deploy files to server
                uses: appleboy/scp-action@v0.1.7
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: root
                  key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  source: .
                  target: /var/www/html/pata.mkopaji
                  strip_components: 1
                  port: 22
                  timeout: 30s
                  command_timeout: 10m
                  use_insecure_cipher: false
                  rm: false
                  debug: false
                  overwrite: false
                  tar_dereference: false
                  tar_exec: tar
                  proxy_port: 22
                  proxy_timeout: 30s
                  proxy_use_insecure_cipher: false
                env:
                  NODE_VERSION: 18


              - name: üîÑ Restart Pata.Mkopaji App with PM2
                uses: appleboy/ssh-action@v1.2.1
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: root
                  key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                    cd /var/www/html/pata.mkopaji
                    echo "üöÄ Starting deployment..."
                    # Install dependencies
                    echo "üì¶ Installing dependencies..."
                    npm ci --only=production
                    # Create logs directory
                    mkdir -p logs
                    # Copy production environment file to .env
                    echo "üîê Setting up production environment..."
                    if [ -f .env.production ]; then
                      cp .env.production .env
                      echo "‚úÖ Copied .env.production to .env"
                    else
                      echo "‚ùå .env.production file not found!"
                      exit 1
                    fi
                    # Stop existing PM2 process
                    echo "üõë Stopping existing application..."
                    pm2 delete pata-mkopaji-production || true
                    # Start application with PM2
                    echo "üöÄ Starting application with PM2..."
                    pm2 start ecosystem.config.js --env production || pm2 restart pata-mkopaji-production
                    # Save PM2 configuration
                    pm2 save
                    # Show PM2 status
                    echo "üìä Application status:"
                    pm2 status
                    # Health check
                    echo "üîç Performing health check..."
                    sleep 5
                    if curl -f http://localhost:3005/api/health > /dev/null 2>&1; then
                      echo "‚úÖ Health check passed"
                    else
                      echo "‚ö†Ô∏è  Health check failed - checking logs..."
                      pm2 logs pata-mkopaji-production --lines 20
                    fi

              - name: ‚úÖ Deployment Success Notification
                if: success()
                uses: appleboy/ssh-action@v1.2.1
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: root
                  key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  script: |
                    echo "üéâ Deployment completed successfully!"
                    echo "üìä Final status:"
                    pm2 status pata-mkopaji-production
                    echo "üåê Application should be available at: https://pata.mkopaji.com:3005"

              - name: üì± Slack notification (success)
                if: success()
                run: |
                  if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"‚úÖ Deployment successful! Pata.Mkopaji app has been deployed to production server."}' \
                    ${{ secrets.SLACK_WEBHOOK_URL }}
                  fi

              - name: üì± Slack notification (failure)
                if: failure()
                run: |
                  if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"‚ùå Deployment failed! Please check the GitHub Actions logs for details."}' \
                    ${{ secrets.SLACK_WEBHOOK_URL }}
                  fi